---
title: "Chapter 2: Pupil-Indexed Arousal and Psychometric Sensitivity in Older Adults"
subtitle: "A Mechanistic Investigation of Physical-Cognitive Effort Interactions"
author: "Mohammad Dastgheib"
date: "`r Sys.Date()`"
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: show
    fig-width: 10
    fig-height: 6
  pdf:
    toc: true
    toc-depth: 3
    keep-tex: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.path = "figures/",
  cache = FALSE
)

library(tidyverse)
library(lme4)
library(broom.mixed)
library(knitr)
library(kableExtra)
library(here)

# Set paths
data_dir <- here("07_manuscript", "chapter2", "data")
processed_dir <- file.path(data_dir, "processed")
output_dir <- here("07_manuscript", "chapter2", "output")
figures_dir <- file.path(output_dir, "figures")
tables_dir <- file.path(output_dir, "tables")
models_dir <- file.path(output_dir, "models")
```

# Introduction and Aims

## Overview

Chapter 2 extends the dual-task paradigm (handgrip + perceptual discrimination) to healthy older adults and tests how physical effort and pupil-indexed arousal relate to psychometric sensitivity. This chapter is anchored in an existing multi-author behavioral manuscript that fits psychometric functions (PFs) and reports effort-related changes in PF parameters.

## Primary Aims

1. **Behavioral backbone (PF outcomes)**: Quantify how High versus Low handgrip effort alters PF-derived thresholds and slopes in older adults, separately for auditory and visual discrimination.

2. **Effort-pupil manipulation check**: Test whether High effort increases tonic and task-evoked pupil dynamics relative to Low effort, providing a physiological manipulation check.

3. **Pupil-psychometric coupling (primary)**: Test whether trial-wise phasic arousal predicts psychometric sensitivity when stimulus intensity is modeled continuously, using hierarchical GLMMs that preserve individual-level arousal granularity.

# Methods

## Participants and Task

Approximately 50 healthy older adults (65+ years) performed auditory and visual same–different discrimination while simultaneously squeezing a dynamometer at Low (5% MVC) or High (40% MVC) effort levels.

**Stimuli:**
- **Auditory:** 1000 Hz base tones with ±8/16/32/64 Hz offsets
- **Visual:** Oriented Gabor patches with ±0.06/0.12/0.24/0.48 contrast differences

**Trial structure:** 3 s pre-squeeze baseline → 3 s sustained squeeze → standard (0.1 s) → ISI (0.5 s) → target (0.1 s) → response window

## Pupil Features and Quality Strategy

Two primary pupil features were computed:

1. **Total AUC:** Baseline-corrected area under the pupil curve over a global trial window, indexing overall arousal during concurrent physical effort.

2. **Cognitive pupil metric (primary):** Baseline-corrected task-evoked measure computed in a fixed-duration post-target window (e.g., 300 ms after target onset through a fixed 1 s window), designed to reduce confounding by RT.

### Quality Tiers

Pupil-based analyses used pre-specified quality tiers:

- **Primary tier:** Window validity ≥ 0.60 for baseline and cognitive windows
- **Lenient tier:** Window validity ≥ 0.50
- **Strict tier:** Window validity ≥ 0.70

## Statistical Models

### Primary GLMM

The primary model treated pupil metric as a continuous predictor using within-subject centering:

$$P^{(\text{trait})}_{j} = \overline{P}_{j}, \qquad P^{(\text{state})}_{ij} = P_{ij} - \overline{P}_{j}$$

The primary GLMM (probit link):

$$\text{probit}(P(Y_{ij}=1)) = \beta_0 + \beta_1 X_{ij} + \beta_2 \text{Effort}_{ij} + \beta_3 \text{Modality}_{ij} + \beta_4 P^{(\text{state})}_{ij} + \beta_5 (X_{ij} \times P^{(\text{state})}_{ij}) + \beta_6 P^{(\text{trait})}_{j} + u_{0j} + u_{1j}X_{ij}$$

The key term is the interaction $X_{ij}\times P^{(\text{state})}_{ij}$, which tests whether within-person fluctuations in arousal are associated with changes in psychometric sensitivity.

# Results

## Behavioral Backbone (PF Outcomes)

```{r pf-backbone, echo=FALSE}
# Load PF parameters if available
pf_file <- file.path(processed_dir, "ch2_pf_parameters.csv")
if (file.exists(pf_file)) {
  pf_params <- read_csv(pf_file, show_col_types = FALSE)
  
  # Summary table
  pf_summary <- pf_params %>%
    filter(converged) %>%
    group_by(task, effort) %>%
    summarise(
      n = n(),
      threshold_mean = mean(threshold, na.rm = TRUE),
      threshold_sd = sd(threshold, na.rm = TRUE),
      slope_mean = mean(slope, na.rm = TRUE),
      slope_sd = sd(slope, na.rm = TRUE),
      .groups = "drop"
    )
  
  kable(pf_summary, 
        col.names = c("Task", "Effort", "N", "Threshold (M)", "Threshold (SD)", 
                     "Slope (M)", "Slope (SD)"),
        digits = 3,
        caption = "Psychometric Function Parameters by Task and Effort") %>%
    kable_styling()
  
  # Figure: PF parameters by effort
  # (Figure generation code here)
} else {
  cat("*PF parameters not yet computed. Run script 02_compute_pf_parameters.R*")
}
```

Psychometric function parameters (thresholds and slopes) were estimated separately for each subject × task × effort combination. [Results will be described here.]

## Effort-Pupil Manipulation Check

```{r effort-pupil-check, echo=FALSE}
# Load model results if available
mod_file <- file.path(models_dir, "mod_effort_cog_auc.rds")
if (file.exists(mod_file)) {
  mod_effort <- readRDS(mod_file)
  
  fe_table <- broom.mixed::tidy(mod_effort, effects = "fixed")
  
  kable(fe_table %>% select(term, estimate, std.error, statistic, p.value),
        col.names = c("Term", "Estimate", "SE", "z", "p"),
        digits = 3,
        caption = "Effort Effect on Cognitive Pupil (Primary Quality Tier)") %>%
    kable_styling()
} else {
  cat("*Effort-pupil manipulation check not yet run. Run script 04_effort_pupil_manipulation_check.R*")
}

# Figure placeholder
# cat("\n![Effort-Pupil Manipulation Check](figures/effort_manipulation_cog_auc.png)\n")
```

High-effort handgrip increased pupil dynamics relative to Low effort, confirming effective engagement of central arousal systems. [Detailed results will be described here.]

## Missingness Diagnostic

```{r missingness, echo=FALSE}
mod_missing_file <- file.path(models_dir, "mod_missingness_diagnostic.rds")
if (file.exists(mod_missing_file)) {
  mod_missing <- readRDS(mod_missing_file)
  
  fe_missing <- broom.mixed::tidy(mod_missing, effects = "fixed", exponentiate = TRUE)
  
  kable(fe_missing %>% select(term, estimate, conf.low, conf.high, p.value),
        col.names = c("Term", "Odds Ratio", "CI Lower", "CI Upper", "p"),
        digits = 3,
        caption = "Missingness Diagnostic: Predictors of Pupil Data Usability") %>%
    kable_styling()
} else {
  cat("*Missingness diagnostic not yet run. Run script 05_missingness_diagnostic.R*")
}
```

Missingness analyses tested whether pupil data retention was predicted by effort, stimulus intensity, modality, or RT. [Results and interpretation will be described here.]

## Pupil-Psychometric Coupling (Primary Analysis)

```{r primary-coupling, echo=FALSE}
mod_primary_file <- file.path(models_dir, "mod_pupil_psychometric_primary.rds")
if (file.exists(mod_primary_file)) {
  mod_primary <- readRDS(mod_primary_file)
  
  fe_primary <- broom.mixed::tidy(mod_primary, effects = "fixed")
  
  # Highlight key interaction term
  kable(fe_primary %>% select(term, estimate, std.error, statistic, p.value),
        col.names = c("Term", "Estimate", "SE", "z", "p"),
        digits = 4,
        caption = "Primary GLMM: Pupil-Psychometric Coupling") %>%
    kable_styling() %>%
    row_spec(which(fe_primary$term == "stimulus_intensity_scaled:pupil_cognitive_state_scaled"),
             bold = TRUE, background = "#ffffcc")
  
  # Extract and report key interaction
  interaction_row <- fe_primary %>%
    filter(term == "stimulus_intensity_scaled:pupil_cognitive_state_scaled")
  
  if (nrow(interaction_row) > 0) {
    cat("\n\n**Key Interaction (Stimulus Intensity × Pupil State):**\n")
    cat(sprintf("- Estimate: %.4f, SE: %.4f, z: %.3f, p: %.4f\n",
                interaction_row$estimate, interaction_row$std.error,
                interaction_row$statistic, interaction_row$p.value))
  }
} else {
  cat("*Primary coupling analysis not yet run. Run script 06_pupil_psychometric_coupling.R*")
}

# Figure placeholder
# cat("\n![Psychometric Functions by Pupil State](figures/psychometric_by_pupil_state.png)\n")
```

The primary analysis tested whether trial-wise phasic arousal (pupil state) predicts psychometric sensitivity when stimulus intensity is modeled continuously. [Results will be described here, including the key interaction term.]

### Robustness Checks

Results were tested across multiple quality tiers (lenient ≥0.50, primary ≥0.60, strict ≥0.70) to ensure robustness. [Summary of robustness results will be described here.]

## Subject-Level PF-Pupil Coupling

```{r subject-coupling, echo=FALSE}
cor_file <- file.path(tables_dir, "pf_pupil_coupling_correlations.csv")
if (file.exists(cor_file)) {
  cor_summary <- read_csv(cor_file, show_col_types = FALSE)
  
  kable(cor_summary,
        col.names = c("Pupil Metric", "PF Parameter", "r", "CI Lower", "CI Upper", "p", "N"),
        digits = 3,
        caption = "Subject-Level Correlations: ΔPupil vs ΔPF Parameters") %>%
    kable_styling()
} else {
  cat("*Subject-level coupling analysis not yet run. Run script 07_pf_pupil_subject_coupling.R*")
}

# Figure placeholders
# cat("\n![PF-Pupil Subject-Level Coupling](figures/pf_pupil_coupling_threshold.png)\n")
```

Subject-level changes in pupil metrics (High–Low effort) were correlated with subject-level changes in PF parameters (High–Low effort). [Results will be described here.]

# Discussion

## Integration with Chapter 1

[Discussion of how Chapter 2 results relate to Chapter 1 findings in younger adults.]

## Implications for Chapter 3

[Discussion of how Chapter 2 results set the foundation for Chapter 3's drift diffusion modeling approach.]

## Limitations

[Discussion of limitations, including pupil data quality constraints, missingness patterns, and sample size considerations.]

## Conclusions

[Summary of key findings and their implications for understanding physical-cognitive effort interactions in aging.]

# References

[References will be added here, following APA style.]

---

**Note:** This report is generated from the Chapter 2 analysis pipeline. To reproduce:

1. Run scripts in order: `01_load_and_validate_data.R` through `08_generate_figures.R`
2. Render this Quarto document: `quarto render chap2_psychometric_pupil.qmd`

