# Chapter 2: Pupil-Indexed Arousal and Psychometric Sensitivity in Older Adults

This directory contains the complete analysis pipeline for Chapter 2 of the dissertation.

## Quick Start

### Run Complete Pipeline

To run all analyses in order:

```r
# From R console (within chapter2 directory)
source("run_analysis.R")
```

Or from command line:

```bash
cd 07_manuscript/chapter2
Rscript run_analysis.R
```

### Run Individual Scripts

Scripts should be run in numerical order:

1. **`scripts/01_load_and_validate_data.R`** - Load and validate merged trial-level data
2. **`scripts/02_compute_pf_parameters.R`** - Fit or load psychometric function parameters
3. **`scripts/03_pupil_quality_tiers.R`** - Define quality tiers and compute within-subject centered pupil metrics
4. **`scripts/04_effort_pupil_manipulation_check.R`** - Test effort effects on pupil dynamics
5. **`scripts/05_missingness_diagnostic.R`** - Analyze missingness patterns
6. **`scripts/06_pupil_psychometric_coupling.R`** - **PRIMARY ANALYSIS**: GLMM linking pupil to psychometric sensitivity
7. **`scripts/07_pf_pupil_subject_coupling.R`** - Subject-level correlations between pupil and PF changes
8. **`scripts/08_generate_figures.R`** - Generate all publication-ready figures

### Generate Report

After running all analyses, render the Quarto report:

```bash
cd reports
quarto render chapter2_dissertation.qmd
```

## Directory Structure

```
chapter2/
├── data/
│   ├── raw/
│   │   ├── behavioral/          # Raw behavioral data files
│   │   │   ├── bap_beh_trialdata_v2.csv
│   │   │   ├── bap_beh_subjxtaskdata_v2.csv
│   │   │   └── LC Aging Subject Data master spreadsheet - *.csv
│   │   └── pupil/               # Raw pupil data (if separate)
│   ├── processed/               # Processed and merged data files
│   │   ├── ch2_triallevel_merged.csv
│   │   ├── ch2_triallevel_pupil.csv  # Pupil-processed data
│   │   └── README_data_source.md     # Data source documentation
│   └── qc/                      # Quality control outputs
├── scripts/                     # Analysis scripts (01-08)
│   └── make_quick_share_v7.R    # Script to regenerate pupil data
├── docs/                        # Documentation files
│   ├── TIMESTAMP_DEFINITIONS.md
│   ├── AUC_CALCULATION_METHOD.md
│   ├── PUPIL_DATA_REPORT_PROMPT.md
│   ├── CHAPTER2_SETUP_PROMPT.md
│   └── CHAPTER2_SETUP_PROMPT_CONCISE.md
├── output/
│   ├── figures/                 # Generated figures
│   ├── tables/                  # Generated tables
│   └── models/                  # Saved model objects (.rds files)
├── reports/                     # Quarto reports
│   ├── chapter2_dissertation.qmd
│   └── pupil_data_report_advisor.qmd
├── config/                      # Configuration files
│   └── paths_config.R          # Centralized path configuration
├── run_analysis.R              # Master script to run all analyses
└── README.md                   # This file
```

## Data Files

### Primary Data Sources

- **`data/processed/ch2_triallevel_merged.csv`**: Pre-merged trial-level data containing both behavioral and pupil measures
- **`data/processed/ch2_triallevel_pupil.csv`**: Pupil-processed data with AUC metrics and quality flags (from `chapter2_materials`)

### Behavioral Data (Raw)

Behavioral data files are located in `data/raw/behavioral/` and sourced from `/Users/mohdasti/Documents/LC-BAP/BAP/Nov2025/`:

- **`bap_beh_trialdata_v2.csv`**: Raw trial-level behavioral data (trial-by-trial responses)
- **`bap_beh_subjxtaskdata_v2.csv`**: Subject-level summaries by task
- **`bap_beh_trialdata_v2_trials_per_subject_per_task.csv`**: Trial counts per subject/task
- **`LC Aging Subject Data master spreadsheet - behavioral.csv`**: Psychometric function parameters (thresholds, slopes) by subject, task, and effort condition
- **`LC Aging Subject Data master spreadsheet - behavioral data dictionary.csv`**: Data dictionary for behavioral spreadsheets
- **`LC Aging Subject Data master spreadsheet - demographics.csv`**: Demographics data
- **`LC Aging Subject Data master spreadsheet - neuropsych.csv`**: Neuropsychology battery data

### Generated Files

- **`data/processed/ch2_pf_parameters.csv`**: Psychometric function parameters (generated by script 02)
- **`data/qc/pupil_quality_summary.csv`**: Quality tier summaries (generated by script 03)
- **`data/qc/missingness_diagnostic.csv`**: Missingness analysis results (generated by script 05)

### Documentation

- **`data/processed/README_data_source.md`**: Documentation of pupil data source and processing methods
- **`docs/TIMESTAMP_DEFINITIONS.md`**: Task timing definitions and window specifications
- **`docs/AUC_CALCULATION_METHOD.md`**: Methodology for AUC calculation
- **`docs/CHAPTER2_SETUP_PROMPT.md`**: Detailed setup guide for Chapter 2
- **`docs/CHAPTER2_SETUP_PROMPT_CONCISE.md`**: Concise setup guide

## Key Analyses

### 1. Behavioral Backbone (PF Outcomes)

Reports psychometric function parameters (thresholds, slopes) from existing behavioral manuscript or re-estimated from trial data. Script: `02_compute_pf_parameters.R`

### 2. Effort-Pupil Manipulation Check

Tests whether High effort increases pupil metrics relative to Low effort. Script: `04_effort_pupil_manipulation_check.R`

### 3. Missingness Diagnostic

Models pupil data missingness to test for systematic bias. Script: `05_missingness_diagnostic.R`

### 4. Pupil-Psychometric Coupling (PRIMARY)

Primary GLMM analysis testing whether trial-wise phasic arousal predicts psychometric sensitivity. Key interaction: `stimulus_intensity × pupil_cognitive_state`. Script: `06_pupil_psychometric_coupling.R`

### 5. Subject-Level PF-Pupil Coupling

Correlates subject-level changes in pupil metrics with changes in PF parameters. Script: `07_pf_pupil_subject_coupling.R`

## Quality Tiers

Pupil data quality tiers are defined based on window validity:

- **Primary tier**: Baseline validity ≥ 0.60 AND cognitive validity ≥ 0.60 (used for primary analyses)
- **Lenient tier**: Baseline validity ≥ 0.50 AND cognitive validity ≥ 0.50 (robustness check)
- **Strict tier**: Baseline validity ≥ 0.70 AND cognitive validity ≥ 0.70 (robustness check)

## Output Files

### Figures (in `output/figures/`)

- `fig1_psychometric_by_effort.png` - Psychometric functions by effort condition
- `fig2_effort_pupil_manipulation.png` - Effort-pupil manipulation check
- `fig3_psychometric_by_pupil_state.png` - Psychometric functions by pupil state tertiles
- `fig4_missingness_diagnostic.png` - Missingness diagnostic plots
- Additional figures from individual scripts

### Tables (in `output/tables/`)

- `effort_cog_auc_effects.csv` - Effort effects on cognitive pupil
- `missingness_diagnostic_effects.csv` - Missingness model results
- `pupil_psychometric_primary_effects.csv` - Primary GLMM results
- `pf_pupil_coupling_correlations.csv` - Subject-level correlations

### Models (in `output/models/`)

Saved R model objects (.rds files) for all fitted models.

## Requirements

### R Packages

```r
install.packages(c(
  "tidyverse",
  "lme4",
  "broom.mixed",
  "GGally",
  "here",
  "kableExtra"
))
```

For Quarto report:

```r
install.packages(c(
  "quarto",
  "knitr"
))
```

## Troubleshooting

### Data file not found

If you get errors about missing data files:

1. Ensure `ch2_triallevel_merged.csv` exists in `data/processed/`
2. If missing, copy from: `/Users/mohdasti/Documents/GitHub/modeling-pupil-DDM/quick_share_v7/analysis_ready/ch2_triallevel.csv`
3. Behavioral data should be in `data/raw/behavioral/` (sourced from `/Users/mohdasti/Documents/LC-BAP/BAP/Nov2025/`)
4. To regenerate pupil data, run: `scripts/make_quick_share_v7.R` (see `docs/README_data_source.md` for details)

### Model convergence issues

If GLMM models fail to converge:

1. Check sample sizes (may need more trials per subject)
2. Try different optimizers (e.g., `bobyqa`, `Nelder_Mead`)
3. Simplify model structure if needed

### Missing dependencies

If you get errors about missing packages, install required packages (see Requirements section above).

## Notes

- Scripts are designed to be run in order, as later scripts depend on outputs from earlier ones
- Models are saved as .rds files for later inspection
- All figures are saved in publication-ready format (PNG, 300 DPI)
- The Quarto report automatically loads model results and generates integrated report

## Contact

For questions or issues, contact: Mohammad Dastgheib

